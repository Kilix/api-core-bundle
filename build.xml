<?xml version="1.0" encoding="UTF-8"?>
<project name="vamos-core" basedir="." default="build:main">
    <!-- Properties -->
    <property name="dir.build" value="${project.basedir}/build" />
    <property name="dir.logs" value="${dir.build}/logs" />
    <property name="dir.coverage" value="${dir.build}/coverage" />

    <!-- Filesets -->
    <fileset id="sourcecode" dir="${dir.src}">
        <include name="**/*.php" />
        <include name="vendor/*" />
    </fileset>

    <!-- Default target -->
    <target name="build:main"
            depends="build:prepare, build:dependencies, build:check, build:test"
            description="Run all test and build everything" />

    <!-- Dependencies target -->
    <target name="build:dependencies"
            depends="dependencies:composer"
            description="Resolves and installs sourcecode dependencies."/>

    <!-- Check target -->
    <target name="build:check"
            depends="build:lint, build:phpcs"
            description="Analyzes app code." />

    <!-- Test target -->
    <target name="build:test"
            depends="test:unit"
            description="Executes all tests.." />

    <!-- Project build clean -->
    <target name="build:clean" description="Clean up build directories.">
        <echo msg="Cleaning build directories ..." />
        <delete dir="${dir.build}" verbose="true" />
    </target>

    <!-- Project build prepare -->
    <target name="build:prepare" description="Create build directories."
        depends="build:clean">
        <echo msg="Creating build directories ..." />
        <mkdir dir="${dir.build}" />
        <mkdir dir="${dir.logs}" />
        <mkdir dir="${dir.coverage}" />
    </target>

    <!-- Composer -->
    <target name="dependencies:composer" description="Handles sourcecode dependencies.">
        <echo msg="Resolving dependencies with PHP Composer ..."/>
        <composer command="install" composer="/usr/local/bin/composer"/>
    </target>

    <target name="build:lint" description="Perform syntax check of sourcecode files">
        <phplint>
            <fileset dir="${project.basedir}">
                <include name="**/*.php"/>
                <exclude name="vendor/**/*.php" />
            </fileset>
        </phplint>
    </target>

    <target name="build:phpcs"
            depends="build:prepare"
            description="Find coding standard violations using PHP_CodeSniffer and log result in XML format. Intended for usage within a continuous integration environment.">
        <exec passthru="true" command="phpcs --report=checkstyle --report-file=${dir.logs}/checkstyle.xml --standard=PSR2 --extensions=php --ignore=vendor ${project.basedir}">
        </exec>
    </target>

    <!-- Unit tests -->
    <target name="test:unit" description="Executes unit tests.">
        <exec passthru="true" command="phpunit --log-junit ${dir.build}/phpunit.xml --coverage-clover ${dir.build}/clover.xml --coverage-html ${dir.coverage}/"/>
    </target>
</project>
